# .github/workflows/ci.yml

name: CI - Lint and Test Dotfiles

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the main/master branch
  push:
    branches:
      - main
      - master
  # Triggers the workflow on pull request events for the main/master branch
  pull_request:
    branches:
      - main
      - master

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Job 1: This job lints all shell scripts in the repository for potential bugs and style issues.
  lint:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Run ShellCheck to analyze shell scripts
        # This uses a popular, pre-built shellcheck action from the GitHub Marketplace.
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          # Recursively scan all files with a .sh extension and the main install script.
          scandir: './'

  # Job 2: This job tests the installation script across multiple, specified versions of Ubuntu.
  # It will only run if the 'lint' job completes successfully.
  test-installation:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    needs: lint
    runs-on: ${{ matrix.ubuntu-version }}
    strategy:
      # This matrix strategy tells GitHub Actions to run a copy of this job for each
      # Ubuntu version listed below. This ensures broad compatibility.
      matrix:
        ubuntu-version: [ubuntu-22.04, ubuntu-24.04]

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/packages.apt.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Make install scripts executable
        run: chmod +x install.sh scripts/*.sh

      - name: Execute installation script
        run: ./install.sh

      - name: Verify Neovim installation
        run: nvim --version

      - name: Verify Stow installation
        run: stow --version