name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck Validation
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck on install.sh
        run: shellcheck -x install.sh || true
      
      - name: Run ShellCheck on scripts
        run: |
          for script in scripts/*.sh; do
            echo "Checking $script..."
            shellcheck -x "$script" || true
          done

  test-dry-run:
    name: Test Dry Run Mode
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run dry-run installation
        run: ./install.sh --dry-run --yes --log=dry-run.log
      
      - name: Check dry-run log
        run: |
          if [ -f dry-run.log ]; then
            echo "Dry-run log created successfully"
            tail -20 dry-run.log
          fi
      
      - name: Upload dry-run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-log
          path: dry-run.log
          retention-days: 7

  test-installation:
    name: Test Full Installation
    runs-on: ubuntu-24.04
    needs: test-dry-run
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run full installation
        run: ./install.sh --yes --log=install.log
        env:
          CI: true
      
      - name: Verify installation
        run: |
          if [ -f scripts/verify-install.sh ]; then
            bash scripts/verify-install.sh || echo "Verification completed with warnings"
          fi
      
      - name: Check installed tools
        run: |
          echo "Checking installed tools..."
          command -v nvim && nvim --version | head -1 || echo "Neovim not found"
          command -v tmux && tmux -V || echo "Tmux not found"
          command -v fzf && fzf --version || echo "FZF not found"
          command -v rg && rg --version | head -1 || echo "Ripgrep not found"
          command -v fd && fd --version || echo "fd not found"
          command -v git && git --version || echo "Git not found"
      
      - name: Check dotfiles applied
        run: |
          echo "Checking dotfiles..."
          [ -f ~/.bashrc ] && echo "✓ .bashrc exists" || echo "✗ .bashrc missing"
          [ -f ~/.gitconfig ] && echo "✓ .gitconfig exists" || echo "✗ .gitconfig missing"
          [ -f ~/.tmux.conf ] && echo "✓ .tmux.conf exists" || echo "✗ .tmux.conf missing"
      
      - name: Upload installation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-log
          path: install.log
          retention-days: 7

  test-bats:
    name: Run Bats Tests
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install bats
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bats
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run bats tests
        run: bats tests/basic.bats

  test-rollback:
    name: Test Rollback Functionality
    runs-on: ubuntu-24.04
    needs: test-installation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Create test files
        run: |
          echo "test" > ~/.bashrc
          echo "test" > ~/.gitconfig
      
      - name: Run installation
        run: ./install.sh --yes
        env:
          CI: true
      
      - name: Check backup created
        run: |
          BACKUP=$(ls -t ~/.dotfiles_backups_* 2>/dev/null | head -1)
          if [ -n "$BACKUP" ]; then
            echo "✓ Backup manifest created: $BACKUP"
            cat "$BACKUP"
          else
            echo "✗ No backup manifest found"
            exit 1
          fi
      
      - name: Test rollback
        run: |
          if [ -f scripts/rollback.sh ]; then
            bash scripts/rollback.sh || echo "Rollback completed"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-24.04
    needs: [shellcheck, test-dry-run, test-installation, test-bats, test-rollback]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "CI Pipeline Summary"
          echo "==================="
          echo "All tests completed"
