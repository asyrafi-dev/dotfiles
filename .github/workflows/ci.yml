name: ğŸš€ CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: ğŸ” ShellCheck Validation
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck on install.sh
        run: shellcheck -x install.sh || true
      
      - name: Run ShellCheck on scripts
        run: |
          for script in scripts/*.sh; do
            echo "Checking $script..."
            shellcheck -x "$script" || true
          done

  test-dry-run:
    name: ğŸ§ª Dry Run Test
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run dry-run installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running dry-run installation..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ./install.sh --dry-run --yes --log=dry-run.log
          echo "âœ… Dry-run completed successfully!"
      
      - name: Check dry-run log
        run: |
          if [ -f dry-run.log ]; then
            echo "Dry-run log created successfully"
            tail -20 dry-run.log
          fi
      
      - name: Upload dry-run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-log
          path: dry-run.log
          retention-days: 7

  test-installation:
    name: ğŸ“¦ Full Installation Test
    runs-on: ubuntu-24.04
    needs: test-dry-run
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run full installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Running full installation..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ./install.sh --yes --log=install.log
          echo "âœ… Installation completed!"
        env:
          CI: true
      
      - name: Verify installation
        run: |
          if [ -f scripts/verify-install.sh ]; then
            bash scripts/verify-install.sh || echo "Verification completed with warnings"
          fi
      
      - name: Check installed tools
        run: |
          echo "Checking installed tools..."
          command -v nvim && nvim --version | head -1 || echo "Neovim not found"
          command -v tmux && tmux -V || echo "Tmux not found"
          command -v fzf && fzf --version || echo "FZF not found"
          command -v rg && rg --version | head -1 || echo "Ripgrep not found"
          command -v fd && fd --version || echo "fd not found"
          command -v git && git --version || echo "Git not found"
      
      - name: Check Node.js and NVM installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŸ¢ Checking Node.js and NVM..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Source bashrc to load NVM
          source ~/.bashrc || true
          
          # Check NVM
          if [ -d "$HOME/.nvm" ]; then
            echo "âœ… NVM directory exists"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            if command -v nvm >/dev/null 2>&1; then
              echo "âœ… NVM command available: $(nvm --version)"
            else
              echo "âŒ NVM command not available"
            fi
          else
            echo "âŒ NVM directory not found"
          fi
          
          # Check Node.js
          if command -v node >/dev/null 2>&1; then
            echo "âœ… Node.js installed: $(node -v)"
            
            # Verify it's Node.js 24 (default in CI)
            NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')
            if [ "$NODE_MAJOR" = "24" ]; then
              echo "âœ… Correct Node.js version (24 - DEFAULT) â­"
            else
              echo "âš ï¸  Unexpected Node.js version: $NODE_MAJOR (expected 24)"
            fi
          else
            echo "âŒ Node.js not found"
            exit 1
          fi
          
          # Check npm
          if command -v npm >/dev/null 2>&1; then
            echo "âœ… npm installed: $(npm -v)"
            
            # For Node 24, npm should be latest (11.x or higher)
            NPM_MAJOR=$(npm -v | cut -d'.' -f1)
            if [ "$NPM_MAJOR" -ge 11 ]; then
              echo "âœ… npm is up to date (v$NPM_MAJOR.x) - Latest for Node 24!"
            else
              echo "âš ï¸  npm version might be outdated: $(npm -v)"
            fi
          else
            echo "âŒ npm not found"
            exit 1
          fi
          
          # Test npm functionality
          echo ""
          echo "Testing npm functionality..."
          npm --version >/dev/null 2>&1 && echo "âœ… npm works correctly" || echo "âŒ npm has issues"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Node.js verification passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Check dotfiles applied
        run: |
          echo "Checking dotfiles..."
          [ -f ~/.bashrc ] && echo "âœ“ .bashrc exists" || echo "âœ— .bashrc missing"
          [ -f ~/.gitconfig ] && echo "âœ“ .gitconfig exists" || echo "âœ— .gitconfig missing"
          [ -f ~/.tmux.conf ] && echo "âœ“ .tmux.conf exists" || echo "âœ— .tmux.conf missing"
          
          # Check if .bashrc contains NVM configuration
          if grep -q "NVM_DIR" ~/.bashrc; then
            echo "âœ“ .bashrc contains NVM configuration"
          else
            echo "âš  .bashrc missing NVM configuration"
          fi
      
      - name: Upload installation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-log
          path: install.log
          retention-days: 7

  test-bats:
    name: âš¡ Bats Test Suite
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install bats
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bats
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run bats tests
        run: bats tests/basic.bats

  test-nodejs-versions:
    name: ğŸŸ¢ Node.js ${{ matrix.node_version }}${{ matrix.node_version == '24' && ' (Default)' || '' }}
    runs-on: ubuntu-24.04
    needs: shellcheck
    strategy:
      fail-fast: false
      matrix:
        node_version: ['24', '22', '20', '18']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x scripts/*.sh
      
      - name: ğŸŸ¢ Install Node.js ${{ matrix.node_version }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŸ¢ Installing Node.js ${{ matrix.node_version }}"
          if [ "${{ matrix.node_version }}" = "24" ]; then
            echo "â­ This is the DEFAULT version"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Set environment for non-interactive installation
          export CI=true
          export ASSUME_YES=1
          export DRY_RUN=0
          
          # For non-default versions, modify the script inline
          if [ "${{ matrix.node_version }}" != "24" ]; then
            echo "Creating modified script for Node.js ${{ matrix.node_version }}..."
            sed 's/NODE_VERSION="24"/NODE_VERSION="${{ matrix.node_version }}"/' scripts/install-nodejs.sh > /tmp/install-nodejs-${{ matrix.node_version }}.sh
            chmod +x /tmp/install-nodejs-${{ matrix.node_version }}.sh
            bash /tmp/install-nodejs-${{ matrix.node_version }}.sh
          else
            echo "Running default script for Node.js 24..."
            bash scripts/install-nodejs.sh
          fi
          
          # Verify installation completed
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          if command -v node >/dev/null 2>&1; then
            echo "âœ… Node.js installed: $(node -v)"
            echo "âœ… npm version: $(npm -v)"
          else
            echo "âŒ Node.js installation failed"
            exit 1
          fi
      
      - name: âœ… Verify Node.js ${{ matrix.node_version }}
        run: |
          # Load NVM
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Verification Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŸ¢ Node.js: $(node -v)"
          echo "ğŸ“¦ npm: $(npm -v)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Verify correct major version
          NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')
          if [ "$NODE_MAJOR" = "${{ matrix.node_version }}" ]; then
            echo "âœ… Correct Node.js version installed"
          else
            echo "âŒ Wrong Node.js version: expected ${{ matrix.node_version }}, got $NODE_MAJOR"
            exit 1
          fi
          
          # For Node 24, verify npm is updated
          if [ "${{ matrix.node_version }}" = "24" ]; then
            NPM_MAJOR=$(npm -v | cut -d'.' -f1)
            if [ "$NPM_MAJOR" -ge 10 ]; then
              echo "âœ… npm version acceptable for Node.js 24 (v$NPM_MAJOR.x)"
            else
              echo "âš ï¸  npm version: $(npm -v)"
            fi
          else
            echo "â„¹ï¸  Using bundled npm for Node.js ${{ matrix.node_version }}"
          fi
          
          # Test npm works
          npm --version >/dev/null 2>&1 && echo "âœ… npm functional" || exit 1
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Node.js ${{ matrix.node_version }} test passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  test-rollback:
    name: â®ï¸ Rollback Test
    runs-on: ubuntu-24.04
    needs: test-installation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Create test files
        run: |
          echo "test" > ~/.bashrc
          echo "test" > ~/.gitconfig
      
      - name: Run installation
        run: ./install.sh --yes
        env:
          CI: true
      
      - name: Check backup created
        run: |
          BACKUP=$(ls -t ~/.dotfiles_backups_* 2>/dev/null | head -1)
          if [ -n "$BACKUP" ]; then
            echo "âœ“ Backup manifest created: $BACKUP"
            cat "$BACKUP"
          else
            echo "âœ— No backup manifest found"
            exit 1
          fi
      
      - name: Test rollback
        run: |
          if [ -f scripts/rollback.sh ]; then
            bash scripts/rollback.sh || echo "Rollback completed"
          fi

  summary:
    name: ğŸ“Š CI Summary
    runs-on: ubuntu-24.04
    needs: [shellcheck, test-dry-run, test-installation, test-bats, test-nodejs-versions, test-rollback]
    if: always()
    steps:
      - name: ğŸ“‹ Check Results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "                    ğŸš€ CI PIPELINE SUMMARY                          "
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… All tests completed successfully!"
          echo ""
          echo "ğŸ“¦ Tested Components:"
          echo "   ğŸ” ShellCheck validation"
          echo "   ğŸ§ª Dry-run mode"
          echo "   ğŸ“¦ Full installation"
          echo "   âš¡ Bats test suite"
          echo "   ğŸŸ¢ Node.js versions (24*, 22, 20, 18)"
          echo "   â®ï¸  Rollback functionality"
          echo ""
          echo "â­ Default Node.js version: 24 (with npm latest)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "                    ğŸ‰ READY TO MERGE!                              "
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
