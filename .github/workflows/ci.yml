name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck Validation
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck on install.sh
        run: shellcheck -x install.sh || true
      
      - name: Run ShellCheck on scripts
        run: |
          for script in scripts/*.sh; do
            echo "Checking $script..."
            shellcheck -x "$script" || true
          done

  test-dry-run:
    name: Test Dry Run Mode
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run dry-run installation
        run: ./install.sh --dry-run --yes --log=dry-run.log
      
      - name: Check dry-run log
        run: |
          if [ -f dry-run.log ]; then
            echo "Dry-run log created successfully"
            tail -20 dry-run.log
          fi
      
      - name: Upload dry-run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-log
          path: dry-run.log
          retention-days: 7

  test-installation:
    name: Test Full Installation
    runs-on: ubuntu-24.04
    needs: test-dry-run
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run full installation
        run: ./install.sh --yes --log=install.log
        env:
          CI: true
      
      - name: Verify installation
        run: |
          if [ -f scripts/verify-install.sh ]; then
            bash scripts/verify-install.sh || echo "Verification completed with warnings"
          fi
      
      - name: Check installed tools
        run: |
          echo "Checking installed tools..."
          command -v nvim && nvim --version | head -1 || echo "Neovim not found"
          command -v tmux && tmux -V || echo "Tmux not found"
          command -v fzf && fzf --version || echo "FZF not found"
          command -v rg && rg --version | head -1 || echo "Ripgrep not found"
          command -v fd && fd --version || echo "fd not found"
          command -v git && git --version || echo "Git not found"
      
      - name: Check Node.js and NVM installation
        run: |
          echo "Checking Node.js and NVM..."
          # Source bashrc to load NVM
          source ~/.bashrc || true
          
          # Check NVM
          if [ -d "$HOME/.nvm" ]; then
            echo "✓ NVM directory exists"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            if command -v nvm >/dev/null 2>&1; then
              echo "✓ NVM command available"
              nvm --version
            else
              echo "✗ NVM command not available"
            fi
          else
            echo "✗ NVM directory not found"
          fi
          
          # Check Node.js
          if command -v node >/dev/null 2>&1; then
            echo "✓ Node.js installed: $(node -v)"
            
            # Verify it's Node.js 24 (default in CI)
            NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')
            if [ "$NODE_MAJOR" = "24" ]; then
              echo "✓ Correct Node.js version (24)"
            else
              echo "⚠ Unexpected Node.js version: $NODE_MAJOR (expected 24)"
            fi
          else
            echo "✗ Node.js not found"
            exit 1
          fi
          
          # Check npm
          if command -v npm >/dev/null 2>&1; then
            echo "✓ npm installed: $(npm -v)"
            
            # For Node 24, npm should be latest (11.x or higher)
            NPM_MAJOR=$(npm -v | cut -d'.' -f1)
            if [ "$NPM_MAJOR" -ge 11 ]; then
              echo "✓ npm is up to date (v$NPM_MAJOR.x)"
            else
              echo "⚠ npm version might be outdated: $(npm -v)"
            fi
          else
            echo "✗ npm not found"
            exit 1
          fi
          
          # Test npm functionality
          echo "Testing npm functionality..."
          npm --version >/dev/null 2>&1 && echo "✓ npm works correctly" || echo "✗ npm has issues"
      
      - name: Check dotfiles applied
        run: |
          echo "Checking dotfiles..."
          [ -f ~/.bashrc ] && echo "✓ .bashrc exists" || echo "✗ .bashrc missing"
          [ -f ~/.gitconfig ] && echo "✓ .gitconfig exists" || echo "✗ .gitconfig missing"
          [ -f ~/.tmux.conf ] && echo "✓ .tmux.conf exists" || echo "✗ .tmux.conf missing"
          
          # Check if .bashrc contains NVM configuration
          if grep -q "NVM_DIR" ~/.bashrc; then
            echo "✓ .bashrc contains NVM configuration"
          else
            echo "⚠ .bashrc missing NVM configuration"
          fi
      
      - name: Upload installation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-log
          path: install.log
          retention-days: 7

  test-bats:
    name: Run Bats Tests
    runs-on: ubuntu-24.04
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install bats
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bats
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Run bats tests
        run: bats tests/basic.bats

  test-nodejs-versions:
    name: Test Node.js Installation
    runs-on: ubuntu-24.04
    needs: shellcheck
    strategy:
      matrix:
        node_version: ['18', '20', '22', '24']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x scripts/*.sh
      
      - name: Test Node.js ${{ matrix.node_version }} installation
        run: |
          # Simulate user choice by setting environment
          export CI=true
          export ASSUME_YES=1
          
          # Install NVM and Node.js
          if [ "${{ matrix.node_version }}" = "24" ]; then
            # Default version, no modification needed
            bash scripts/install-nodejs.sh
          else
            # Modify script to install specific version
            sed -i 's/NODE_VERSION="24"/NODE_VERSION="${{ matrix.node_version }}"/' scripts/install-nodejs.sh
            bash scripts/install-nodejs.sh
          fi
      
      - name: Verify Node.js ${{ matrix.node_version }} installation
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "Node.js version: $(node -v)"
          echo "npm version: $(npm -v)"
          
          # Verify correct major version
          NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')
          if [ "$NODE_MAJOR" = "${{ matrix.node_version }}" ]; then
            echo "✓ Correct Node.js version installed"
          else
            echo "✗ Wrong Node.js version: expected ${{ matrix.node_version }}, got $NODE_MAJOR"
            exit 1
          fi
          
          # For Node 24, verify npm is latest
          if [ "${{ matrix.node_version }}" = "24" ]; then
            NPM_MAJOR=$(npm -v | cut -d'.' -f1)
            if [ "$NPM_MAJOR" -ge 11 ]; then
              echo "✓ npm updated to latest for Node.js 24"
            else
              echo "✗ npm not updated for Node.js 24"
              exit 1
            fi
          fi
          
          # Test npm works
          npm --version >/dev/null 2>&1 && echo "✓ npm functional" || exit 1

  test-rollback:
    name: Test Rollback Functionality
    runs-on: ubuntu-24.04
    needs: test-installation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x install.sh scripts/*.sh
      
      - name: Create test files
        run: |
          echo "test" > ~/.bashrc
          echo "test" > ~/.gitconfig
      
      - name: Run installation
        run: ./install.sh --yes
        env:
          CI: true
      
      - name: Check backup created
        run: |
          BACKUP=$(ls -t ~/.dotfiles_backups_* 2>/dev/null | head -1)
          if [ -n "$BACKUP" ]; then
            echo "✓ Backup manifest created: $BACKUP"
            cat "$BACKUP"
          else
            echo "✗ No backup manifest found"
            exit 1
          fi
      
      - name: Test rollback
        run: |
          if [ -f scripts/rollback.sh ]; then
            bash scripts/rollback.sh || echo "Rollback completed"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-24.04
    needs: [shellcheck, test-dry-run, test-installation, test-bats, test-nodejs-versions, test-rollback]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "CI Pipeline Summary"
          echo "==================="
          echo "All tests completed"
